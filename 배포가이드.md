# ğŸ“° ë‰´ìŠ¤ë ˆí„° CronJob ë°°í¬ ê°€ì´ë“œ

## ğŸ¯ ê°œìš”
ë§¤ì¼ ì˜¤ì „ 8ì‹œì— TLDR ë‰´ìŠ¤ë ˆí„°ë¥¼ ìë™ìœ¼ë¡œ ìš”ì•½í•˜ì—¬ ë©”ì¼ ë°œì†¡í•˜ëŠ” Kubernetes CronJob ë°°í¬ ê°€ì´ë“œ

---

## ğŸš€ 1ë‹¨ê³„: Azure Cloud Shell ì ‘ì† ë° ì„¤ì •

### Azure Cloud Shell ì ‘ì†
1. Azure Portal (portal.azure.com) ë¡œê·¸ì¸
2. ìƒë‹¨ Cloud Shell ì•„ì´ì½˜ í´ë¦­
3. Bash í™˜ê²½ ì„ íƒ

### AKS ì—°ê²° ì„¤ì •
```bash
# êµ¬ë… ì„¤ì •
az account set --subscription "sub-900001179-datasolution-01"

# AKS ì¸ì¦ì •ë³´ ê°€ì ¸ì˜¤ê¸°
az aks get-credentials \
  --resource-group rg-az01-dev-multiagent-platform-01 \
  --name aks-az01-dev-magent-plat-01 \
  --overwrite-existing

# ì—°ê²° í™•ì¸
kubectl get nodes
```

---

## ğŸ“ 2ë‹¨ê³„: í”„ë¡œì íŠ¸ íŒŒì¼ ì—…ë¡œë“œ

### Cloud Shellì— íŒŒì¼ ì—…ë¡œë“œ
1. Cloud Shellì—ì„œ **ì—…ë¡œë“œ** ë²„íŠ¼ í´ë¦­
2. ë‹¤ìŒ íŒŒì¼ë“¤ì„ ì—…ë¡œë“œ:
   - `main.py`
   - `requirements.txt`
   - `Dockerfile`
   - `k8s-newsletter-cronjob.yaml`
   - `k8s-newsletter-secrets.yaml`

### ë˜ëŠ” Git Clone ì‚¬ìš©
```bash
# ë§Œì•½ GitHubì— ì˜¬ë ¤ë†¨ë‹¤ë©´
git clone <your-repo-url>
cd <your-repo-name>
```

---

## ğŸ” 3ë‹¨ê³„: ì„¤ì • íŒŒì¼ ìˆ˜ì •

### config.py íŒŒì¼ ìƒì„±
```bash
cat > config.py << 'EOF'
import os

# Gmail ì„¤ì •
GMAIL_EMAIL = os.getenv('GMAIL_EMAIL')
GMAIL_APP_PASSWORD = os.getenv('GMAIL_APP_PASSWORD')

# Azure OpenAI ì„¤ì •
AZURE_OPENAI_ENDPOINT = os.getenv('AZURE_OPENAI_ENDPOINT')
AZURE_OPENAI_API_KEY = os.getenv('AZURE_OPENAI_API_KEY')
AZURE_OPENAI_DEPLOYMENT_NAME = os.getenv('AZURE_OPENAI_DEPLOYMENT_NAME')
AZURE_OPENAI_API_VERSION = os.getenv('AZURE_OPENAI_API_VERSION')

# TLDR ë°œì‹ ì ë©”ì¼
TLDR_SENDER_EMAILS = ["no-reply@tldr.tech", "newsletter@tldr.tech"]

# ìˆ˜ì‹ ì ë©”ì¼ (ì‹¤ì œ ë©”ì¼ë¡œ ë³€ê²½ í•„ìš”!)
RECIPIENT_EMAILS = ["your-email@company.com"]

# ë¡œê·¸ ì„¤ì •
LOG_DIR = "logs"
LOG_FILE = "newsletter.log"
EOF
```

### Secret íŒŒì¼ ìˆ˜ì •
```bash
# Secret íŒŒì¼ í¸ì§‘ (ì‹¤ì œ ê°’ìœ¼ë¡œ ë³€ê²½ í•„ìš”!)
nano k8s-newsletter-secrets.yaml
```

**âš ï¸ ë°˜ë“œì‹œ ìˆ˜ì •í•´ì•¼ í•  ê°’ë“¤:**
- `gmail-email`: ì‹¤ì œ Gmail ì£¼ì†Œ
- `gmail-app-password`: Gmail ì•± ë¹„ë°€ë²ˆí˜¸
- `azure-openai-endpoint`: Azure OpenAI ì—”ë“œí¬ì¸íŠ¸
- `azure-openai-api-key`: Azure OpenAI API í‚¤
- `azure-openai-deployment-name`: ë°°í¬ëœ ëª¨ë¸ ì´ë¦„
- config.pyì˜ `RECIPIENT_EMAILS`: ìˆ˜ì‹ ì ë©”ì¼ ì£¼ì†Œ

---

## ğŸ³ 4ë‹¨ê³„: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ

### ACR ë¡œê·¸ì¸
```bash
az acr login --name ossknowledgeregistry
```

### ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
```bash
# ì´ë¯¸ì§€ ë¹Œë“œ
docker build -t ossknowledgeregistry.azurecr.io/newsletter:latest .

# ACRì— í‘¸ì‹œ
docker push ossknowledgeregistry.azurecr.io/newsletter:latest

# ì´ë¯¸ì§€ í™•ì¸
az acr repository show-tags --name ossknowledgeregistry --repository newsletter
```

---

## âš™ï¸ 5ë‹¨ê³„: Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬

### ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±
```bash
kubectl create namespace newsletter
```

### Secret ë°°í¬
```bash
kubectl apply -f k8s-newsletter-secrets.yaml
```

### ConfigMap ìƒì„± (config.pyìš©)
```bash
kubectl create configmap newsletter-config --from-file=config.py -n newsletter
```

### CronJob ë°°í¬
```bash
kubectl apply -f k8s-newsletter-cronjob.yaml
```

### ë°°í¬ í™•ì¸
```bash
# ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
kubectl get namespace newsletter

# CronJob í™•ì¸
kubectl get cronjobs -n newsletter

# Secret í™•ì¸
kubectl get secrets -n newsletter

# ConfigMap í™•ì¸
kubectl get configmaps -n newsletter

# ì „ì²´ ë¦¬ì†ŒìŠ¤ í•œë²ˆì— í™•ì¸
kubectl get all -n newsletter
```

---

## ğŸ” 6ë‹¨ê³„: ë™ì‘ í™•ì¸ ë° í…ŒìŠ¤íŠ¸

### ìˆ˜ë™ Job ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
```bash
# CronJobì—ì„œ ì¦‰ì‹œ Job ìƒì„±
kubectl create job newsletter-test --from=cronjob/newsletter-cronjob -n newsletter

# Job ì‹¤í–‰ ìƒíƒœ í™•ì¸
kubectl get jobs -n newsletter

# Pod ë¡œê·¸ í™•ì¸
kubectl logs job/newsletter-test -n newsletter
```

### CronJob ìŠ¤ì¼€ì¤„ í™•ì¸
```bash
# CronJob ìƒíƒœ í™•ì¸
kubectl describe cronjob newsletter-cronjob -n newsletter

# ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ í™•ì¸
kubectl get cronjob newsletter-cronjob -n newsletter -o yaml | grep -A 5 "schedule"
```

### ë¡œê·¸ ëª¨ë‹ˆí„°ë§
```bash
# ì‹¤ì‹œê°„ ë¡œê·¸ í™•ì¸
kubectl logs -f job/newsletter-test -n newsletter

# ì™„ë£Œëœ Jobë“¤ì˜ ë¡œê·¸ í™•ì¸
kubectl get jobs -n newsletter
kubectl logs job/<job-name> -n newsletter
```

---

## ğŸ› ï¸ 7ë‹¨ê³„: ê´€ë¦¬ ëª…ë ¹ì–´

### CronJob ì¼ì‹œ ì¤‘ì§€
```bash
kubectl patch cronjob newsletter-cronjob -n newsletter -p '{"spec":{"suspend":true}}'
```

### CronJob ì¬ê°œ
```bash
kubectl patch cronjob newsletter-cronjob -n newsletter -p '{"spec":{"suspend":false}}'
```

### ì„¤ì • ì—…ë°ì´íŠ¸
```bash
# Secret ì—…ë°ì´íŠ¸
kubectl apply -f k8s-newsletter-secrets.yaml

# ìƒˆ ì´ë¯¸ì§€ ë°°í¬
docker build -t ossknowledgeregistry.azurecr.io/newsletter:v2 .
docker push ossknowledgeregistry.azurecr.io/newsletter:v2

# CronJob ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸
kubectl patch cronjob newsletter-cronjob -n newsletter -p '{"spec":{"jobTemplate":{"spec":{"template":{"spec":{"containers":[{"name":"newsletter","image":"ossknowledgeregistry.azurecr.io/newsletter:v2"}]}}}}}}'
```

### ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ (í•œë°©ì—!)
```bash
# ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì‚­ì œí•˜ë©´ ëª¨ë“  ë¦¬ì†ŒìŠ¤ í•¨ê»˜ ì‚­ì œë¨
kubectl delete namespace newsletter

# ë˜ëŠ” ê°œë³„ ì‚­ì œ
kubectl delete cronjob newsletter-cronjob -n newsletter
kubectl delete secret newsletter-secrets -n newsletter
kubectl delete configmap newsletter-config -n newsletter
```

---

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ í™•ì¸ì‚¬í•­
- [ ] Gmail ì•± ë¹„ë°€ë²ˆí˜¸ ìƒì„± ì™„ë£Œ
- [ ] Azure OpenAI ì—”ë“œí¬ì¸íŠ¸ ë° API í‚¤ í™•ì¸
- [ ] ìˆ˜ì‹ ì ë©”ì¼ ì£¼ì†Œ ì„¤ì • í™•ì¸
- [ ] AKS í´ëŸ¬ìŠ¤í„° ì—°ê²° í™•ì¸

### ë°°í¬ í›„ í™•ì¸ì‚¬í•­
- [ ] Docker ì´ë¯¸ì§€ ACR í‘¸ì‹œ ì™„ë£Œ
- [ ] Secret ìƒì„± ì™„ë£Œ
- [ ] ConfigMap ìƒì„± ì™„ë£Œ
- [ ] CronJob ë°°í¬ ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ Job ì‹¤í–‰ ë° ë¡œê·¸ í™•ì¸
- [ ] ë©”ì¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

---

## ğŸš¨ ë¬¸ì œ í•´ê²°

### ì¼ë°˜ì ì¸ ì´ìŠˆë“¤

#### 1. ì´ë¯¸ì§€ í’€ ì‹¤íŒ¨
```bash
# ACR ì—°ê²° í™•ì¸
az acr login --name ossknowledgeregistry
kubectl get secrets | grep acr-secret
```

#### 2. Secret ê°’ ì˜¤ë¥˜
```bash
# Secret ë‚´ìš© í™•ì¸
kubectl get secret newsletter-secrets -o yaml
```

#### 3. Job ì‹¤í–‰ ì‹¤íŒ¨
```bash
# Pod ìƒì„¸ ë¡œê·¸ í™•ì¸
kubectl describe pod <pod-name>
kubectl logs <pod-name>
```

#### 4. ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨
- Gmail ì•± ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸
- 2ë‹¨ê³„ ì¸ì¦ í™œì„±í™” í™•ì¸
- ìˆ˜ì‹ ì ë©”ì¼ ì£¼ì†Œ í™•ì¸

---

## ğŸ“… ì‹¤í–‰ ìŠ¤ì¼€ì¤„

**í˜„ì¬ ì„¤ì •**: ë§¤ì¼ ì˜¤ì „ 8ì‹œ (KST)
- Cron í‘œí˜„ì‹: `"0 23 * * *"` (UTC ê¸°ì¤€ 23ì‹œ = KST 08ì‹œ)
- timeZone: `"Asia/Seoul"`

**ë‹¤ë¥¸ ì‹œê°„ìœ¼ë¡œ ë³€ê²½í•˜ë ¤ë©´:**
```bash
# ì˜¤ì „ 9ì‹œë¡œ ë³€ê²½ ì˜ˆì‹œ
kubectl patch cronjob newsletter-cronjob -p '{"spec":{"schedule":"0 0 * * *"}}'
```

---

**ğŸ‰ ë°°í¬ ì™„ë£Œ! ì´ì œ ë§¤ì¼ ì˜¤ì „ 8ì‹œì— ìë™ìœ¼ë¡œ ë‰´ìŠ¤ë ˆí„°ê°€ ë°œì†¡ë©ë‹ˆë‹¤.**