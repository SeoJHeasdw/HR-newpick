# 📰 뉴스레터 CronJob 배포 가이드

## 🎯 개요
매일 오전 8시에 TLDR 뉴스레터를 자동으로 요약하여 메일 발송하는 Kubernetes CronJob 배포 가이드

---

## 🚀 1단계: Azure Cloud Shell 접속 및 설정

### Azure Cloud Shell 접속
1. Azure Portal (portal.azure.com) 로그인
2. 상단 Cloud Shell 아이콘 클릭
3. Bash 환경 선택

### AKS 연결 설정
```bash
# 구독 설정
az account set --subscription "sub-900001179-datasolution-01"

# AKS 인증정보 가져오기
az aks get-credentials \
  --resource-group rg-az01-dev-multiagent-platform-01 \
  --name aks-az01-dev-magent-plat-01 \
  --overwrite-existing

# 연결 확인
kubectl get nodes
```

---

## 📁 2단계: 프로젝트 파일 업로드

### Cloud Shell에 파일 업로드
1. Cloud Shell에서 **업로드** 버튼 클릭
2. 다음 파일들을 업로드:
   - `main.py`
   - `requirements.txt`
   - `Dockerfile`
   - `k8s-newsletter-cronjob.yaml`
   - `k8s-newsletter-secrets.yaml`

### 또는 Git Clone 사용
```bash
# 만약 GitHub에 올려놨다면
git clone <your-repo-url>
cd <your-repo-name>
```

---

## 🔐 3단계: 설정 파일 수정

### config.py 파일 생성
```bash
cat > config.py << 'EOF'
import os

# Gmail 설정
GMAIL_EMAIL = os.getenv('GMAIL_EMAIL')
GMAIL_APP_PASSWORD = os.getenv('GMAIL_APP_PASSWORD')

# Azure OpenAI 설정
AZURE_OPENAI_ENDPOINT = os.getenv('AZURE_OPENAI_ENDPOINT')
AZURE_OPENAI_API_KEY = os.getenv('AZURE_OPENAI_API_KEY')
AZURE_OPENAI_DEPLOYMENT_NAME = os.getenv('AZURE_OPENAI_DEPLOYMENT_NAME')
AZURE_OPENAI_API_VERSION = os.getenv('AZURE_OPENAI_API_VERSION')

# TLDR 발신자 메일
TLDR_SENDER_EMAILS = ["no-reply@tldr.tech", "newsletter@tldr.tech"]

# 수신자 메일 (실제 메일로 변경 필요!)
RECIPIENT_EMAILS = ["your-email@company.com"]

# 로그 설정
LOG_DIR = "logs"
LOG_FILE = "newsletter.log"
EOF
```

### Secret 파일 수정
```bash
# Secret 파일 편집 (실제 값으로 변경 필요!)
nano k8s-newsletter-secrets.yaml
```

**⚠️ 반드시 수정해야 할 값들:**
- `gmail-email`: 실제 Gmail 주소
- `gmail-app-password`: Gmail 앱 비밀번호
- `azure-openai-endpoint`: Azure OpenAI 엔드포인트
- `azure-openai-api-key`: Azure OpenAI API 키
- `azure-openai-deployment-name`: 배포된 모델 이름
- config.py의 `RECIPIENT_EMAILS`: 수신자 메일 주소

---

## 🐳 4단계: Docker 이미지 빌드 및 푸시

### ACR 로그인
```bash
az acr login --name ossknowledgeregistry
```

### 이미지 빌드 및 푸시
```bash
# 이미지 빌드
docker build -t ossknowledgeregistry.azurecr.io/newsletter:latest .

# ACR에 푸시
docker push ossknowledgeregistry.azurecr.io/newsletter:latest

# 이미지 확인
az acr repository show-tags --name ossknowledgeregistry --repository newsletter
```

---

## ⚙️ 5단계: Kubernetes 리소스 배포

### 네임스페이스 생성
```bash
kubectl create namespace newsletter
```

### Secret 배포
```bash
kubectl apply -f k8s-newsletter-secrets.yaml
```

### ConfigMap 생성 (config.py용)
```bash
kubectl create configmap newsletter-config --from-file=config.py -n newsletter
```

### CronJob 배포
```bash
kubectl apply -f k8s-newsletter-cronjob.yaml
```

### 배포 확인
```bash
# 네임스페이스 확인
kubectl get namespace newsletter

# CronJob 확인
kubectl get cronjobs -n newsletter

# Secret 확인
kubectl get secrets -n newsletter

# ConfigMap 확인
kubectl get configmaps -n newsletter

# 전체 리소스 한번에 확인
kubectl get all -n newsletter
```

---

## 🔍 6단계: 동작 확인 및 테스트

### 수동 Job 실행 (테스트용)
```bash
# CronJob에서 즉시 Job 생성
kubectl create job newsletter-test --from=cronjob/newsletter-cronjob -n newsletter

# Job 실행 상태 확인
kubectl get jobs -n newsletter

# Pod 로그 확인
kubectl logs job/newsletter-test -n newsletter
```

### CronJob 스케줄 확인
```bash
# CronJob 상태 확인
kubectl describe cronjob newsletter-cronjob -n newsletter

# 다음 실행 시간 확인
kubectl get cronjob newsletter-cronjob -n newsletter -o yaml | grep -A 5 "schedule"
```

### 로그 모니터링
```bash
# 실시간 로그 확인
kubectl logs -f job/newsletter-test -n newsletter

# 완료된 Job들의 로그 확인
kubectl get jobs -n newsletter
kubectl logs job/<job-name> -n newsletter
```

---

## 🛠️ 7단계: 관리 명령어

### CronJob 일시 중지
```bash
kubectl patch cronjob newsletter-cronjob -n newsletter -p '{"spec":{"suspend":true}}'
```

### CronJob 재개
```bash
kubectl patch cronjob newsletter-cronjob -n newsletter -p '{"spec":{"suspend":false}}'
```

### 설정 업데이트
```bash
# Secret 업데이트
kubectl apply -f k8s-newsletter-secrets.yaml

# 새 이미지 배포
docker build -t ossknowledgeregistry.azurecr.io/newsletter:v2 .
docker push ossknowledgeregistry.azurecr.io/newsletter:v2

# CronJob 이미지 업데이트
kubectl patch cronjob newsletter-cronjob -n newsletter -p '{"spec":{"jobTemplate":{"spec":{"template":{"spec":{"containers":[{"name":"newsletter","image":"ossknowledgeregistry.azurecr.io/newsletter:v2"}]}}}}}}'
```

### 🗑️ 전체 삭제 (한방에!)
```bash
# 네임스페이스 삭제하면 모든 리소스 함께 삭제됨
kubectl delete namespace newsletter

# 또는 개별 삭제
kubectl delete cronjob newsletter-cronjob -n newsletter
kubectl delete secret newsletter-secrets -n newsletter
kubectl delete configmap newsletter-config -n newsletter
```

---

## 📋 체크리스트

### 배포 전 확인사항
- [ ] Gmail 앱 비밀번호 생성 완료
- [ ] Azure OpenAI 엔드포인트 및 API 키 확인
- [ ] 수신자 메일 주소 설정 확인
- [ ] AKS 클러스터 연결 확인

### 배포 후 확인사항
- [ ] Docker 이미지 ACR 푸시 완료
- [ ] Secret 생성 완료
- [ ] ConfigMap 생성 완료
- [ ] CronJob 배포 완료
- [ ] 테스트 Job 실행 및 로그 확인
- [ ] 메일 발송 테스트 완료

---

## 🚨 문제 해결

### 일반적인 이슈들

#### 1. 이미지 풀 실패
```bash
# ACR 연결 확인
az acr login --name ossknowledgeregistry
kubectl get secrets | grep acr-secret
```

#### 2. Secret 값 오류
```bash
# Secret 내용 확인
kubectl get secret newsletter-secrets -o yaml
```

#### 3. Job 실행 실패
```bash
# Pod 상세 로그 확인
kubectl describe pod <pod-name>
kubectl logs <pod-name>
```

#### 4. 메일 발송 실패
- Gmail 앱 비밀번호 재확인
- 2단계 인증 활성화 확인
- 수신자 메일 주소 확인

---

## 📅 실행 스케줄

**현재 설정**: 매일 오전 8시 (KST)
- Cron 표현식: `"0 23 * * *"` (UTC 기준 23시 = KST 08시)
- timeZone: `"Asia/Seoul"`

**다른 시간으로 변경하려면:**
```bash
# 오전 9시로 변경 예시
kubectl patch cronjob newsletter-cronjob -p '{"spec":{"schedule":"0 0 * * *"}}'
```

---

**🎉 배포 완료! 이제 매일 오전 8시에 자동으로 뉴스레터가 발송됩니다.**